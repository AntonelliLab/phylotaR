<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>phylotaR Tutorial • phylotaR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="phylotaR Tutorial">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phylotaR</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/phylotaR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/AntonelliLab/phylotaR#readme">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>phylotaR Tutorial</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/AntonelliLab/phylotaR#readme/blob/master/vignettes/phylotaR.Rmd"><code>vignettes/phylotaR.Rmd</code></a></small>
      <div class="hidden name"><code>phylotaR.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The first step to running a phylogenetic analysis is the identification of overlapping sequences. Often orthology is determined by pairing sequences whose gene names match (e.g. COI sequences with COI sequences, rbcl sequences with rbcl sequences). Problems can arise however if gene names differ between authors, if different gene sections are represented or if sequences are mislabelled. These issues can be especially problematic for large-scale analyses where individual errors cannot be detected.</p>
<p><a href="https://www.ncbi.nlm.nih.gov/pubmed/18570030">PhyLoTa</a> is a pipeline that uses an alignment search tool to identify orthologous sequences without the need for gene name matching. For a given parental taxonomic group, the pipeline will search through available sequences hosted on GenBank and identify orthologous sequence clusters. A user is then able to survey the identified clusters and select the ones which best suit their phylogenetic analysis needs, e.g. by selecting the clusters that maximise the number of taxonomic groups.</p>
<p>This R pacakge, <code>phylotaR</code>, is an R implementation of this pipeline. In this vignette we will demonstrate how to run PhyLoTa using a small taxonomic group. The pipeline is composed of four automated stages (taxise, download, cluster, cluster2) and a final user-performed stage of cluster selection.</p>
</div>
<div id="installing-ncbi-blast-tools" class="section level1">
<h1 class="hasAnchor">
<a href="#installing-ncbi-blast-tools" class="anchor"></a>Installing NCBI BLAST+ Tools</h1>
<p>The PhyLoTa pipeline uses BLAST to identify orthologous sequence clusters. In order to run phylotaR, a local copy of the BLAST software must be installed on your computer. <strong>Installing the phylotaR package does not install BLAST, it must be installed separately</strong>. To install BLAST+, please see the NCBI website’s <a href="https://www.ncbi.nlm.nih.gov/books/NBK279671/">installation instructions</a>.</p>
</div>
<div id="pipeline" class="section level1">
<h1 class="hasAnchor">
<a href="#pipeline" class="anchor"></a>Pipeline</h1>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>For demonstration purposes we will run the pipeline on a small taxonomic group. Because they are charismatic and relatively well-studied, we will select the Night Monkey genus, <a href="https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Info&amp;id=9504">Aotus</a>. Now that we have decided on a taxonomic group we need to find out its unique taxonomic ID. This can be looked up by navigating to the <a href="https://www.ncbi.nlm.nih.gov/taxonomy">NCBI taxonomy webpage</a> and searching ‘Aotus’. Doing this, we can see that Aotus ID is <strong>9504</strong>. We will need this number for specifying the parameters in our pipeline. (Notice, that there is also a plant genus called Aotus.)</p>
<p>To begin a run, we will need to create a new folder that will contain all the output files generated by the <code>phylotaR</code> pipeline. Since we are running the analysis on the Aotus genus, let’s call the folder <code>aotus/</code>. Now we have our working directory folder created, we can now open R and run the following code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(phylotaR)
wd &lt;-<span class="st"> '[YOUR PATH TO AOTUS FOLDER]'</span>
ncbi_dr &lt;-<span class="st"> '[YOUR PATH TO NCBI BLAST TOOLS]'</span>
txid &lt;-<span class="st"> </span><span class="dv">9504</span>
<span class="kw"><a href="../reference/setup.html">setup</a></span>(<span class="dt">wd =</span> wd, <span class="dt">txid =</span> txid, <span class="dt">ncbi_dr =</span> ncbi_dr, <span class="dt">v=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>The above imports the <code>phylotaR</code> package and initiates a cache that will contain the pipeline parameters. For this tutorial we will keep the parameters as their default. For more information on the parameters please see the publication, <a href="https://doi.org/10.3390/life8020020">phylotaR: An Automated Pipeline for Retrieving Orthologous DNA Sequences from GenBank in R</a>. <code>wd</code> must be a file path to the folder we called <code>aotus/</code>. <code>ncbi_dr</code> must be a file path to the folder containing all the NCBI BLAST+ tools – see above ‘Installing NCBI BLAST+ Tools’. Depending on your system and how you installed the tools, they may be in your system path in which case you can simply supply ‘.’ to the <code>ncbi_dr</code> argument. Running <code><a href="../reference/setup.html">setup()</a></code> will verify whether the BLAST tools are installed correctly.</p>
</div>
<div id="running" class="section level2">
<h2 class="hasAnchor">
<a href="#running" class="anchor"></a>Running</h2>
<p>After <code><a href="../reference/setup.html">setup()</a></code> has been run we can run the pipeline with the following command.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">wd =</span> wd)</code></pre></div>
<p>This will run all the automated stages of the pipeline: taxise, download, cluster and cluster2. The first of these stages looks up all the taxonomic information available on the descendants of the parent ID provided, <code>txid</code>. The second downloads representative sequences for all identified descendants. No additional arguments are required other than <code>wd</code> which specifies the working directory that contains the cache and all parameters as set up by <code><a href="../reference/setup.html">setup()</a></code>. In this folder you will also find a <code>log.txt</code> that reports detailed information on the progression of the pipeline as well as all the output files generated by each stage. Additionally, you will see session info and a blast version text files. These files, along with the log, can help debugging if any errors occur. The whole pipeline can complete in around 2 minutes for Aotus using default parameters. Aotus, however, is a genus of only 13 taxa, larger clades will take much longer particularly during the download stage.</p>
</div>
<div id="restarting" class="section level2">
<h2 class="hasAnchor">
<a href="#restarting" class="anchor"></a>Restarting</h2>
<p>The pipeline can be halted and restarted. The cache records all downloaded and generated data by the pipeline. If there is a system crash or the user wishes to halt the program, the pipeline can be restarted from the same point it stopped with the function <code><a href="../reference/restart.html">restart()</a></code>. Additionally, due to the potential random nature of the pipeline, a user may wish to re-run the pipeline from certain stages. This can be achived by first using <code><a href="../reference/reset.html">reset()</a></code> followed by <code><a href="../reference/restart.html">restart()</a></code>. For example, in the code below a completed pipeline is reset to ‘cluster’ and then restarted. After running these commands, the pipeline will run as if it has only just completed the download stage. Note, all resets and restarts are recorded in the log.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/reset.html">reset</a></span>(<span class="dt">wd =</span> wd, <span class="dt">stage =</span> <span class="st">'cluster'</span>)
<span class="kw"><a href="../reference/restart.html">restart</a></span>(<span class="dt">wd =</span> wd)</code></pre></div>
</div>
<div id="cluster-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#cluster-selection" class="anchor"></a>Cluster selection</h2>
<p>After a pipeline has completed, the identified clusters can be interrogated. In the below code, we generate a phylota object using <code><a href="../reference/read_phylota.html">read_phylota()</a></code>. Again, all that is required as an argument is the working directory. The produced object contains cluster, sequence and taxonomic information on all the clusters. It has 6 data slots: cids, sids, txids, txdct, sqs and cls. Each of these slots can be accessed with <code>@</code>, see ?`Phylota-class` for more information. The <code>phylotaR</code> package has a range of functions for probing clusters in a phylota object. For example, if we want to know how many different taxonomic groups are represented by each cluster we can use <code><a href="../reference/get_ntaxa.html">get_ntaxa()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">all_clusters &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_phylota.html">read_phylota</a></span>(wd)
cids &lt;-<span class="st"> </span>all_clusters<span class="op">@</span>cids
n_taxa &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_ntaxa.html">get_ntaxa</a></span>(<span class="dt">phylota =</span> all_clusters, <span class="dt">cid =</span> cids)</code></pre></div>
<p>We can then drop all the clusters with fewer than 6 taxa and create a new phylota object using the <code>drop_cls()</code> function. Let’s then take a peak of the now smaller object’s clusters using <code>summary()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">keep &lt;-<span class="st"> </span>cids[n_taxa <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>]
selected &lt;-<span class="st"> </span><span class="kw"><a href="../reference/drop_clstrs.html">drop_clstrs</a></span>(<span class="dt">phylota =</span> all_clusters, <span class="dt">cid =</span> keep)
smmry &lt;-<span class="st"> </span><span class="kw">summary</span>(selected)</code></pre></div>
<p>In my session, I have the following output:</p>
<pre><code>&gt; smmry
  ID    Type               Seed Parent N_taxa N_seqs Med_sql       MAD                        Definition                   Feature
1  1 subtree    U36844.1/1..602   9504     11     77     688 0.8575607 gene (0.09), mitochondrial (0.07) aotus (0.3), azarai (0.2)
2  5 subtree AJ489745.1/1..1140   9504     11     41    1140 0.9264139       aotus (0.1), complete (0.1)   aotus (0.4), cytb (0.2)
3 11 subtree HQ005472.1/1..1557   9504     10     27    1557 1.0000000        complete (0.1), and (0.07)     co1 (0.7), cox1 (0.3)
4 38 subtree  AF338374.1/1..829   9504      8     10     829 0.9518697            sry (0.2), aotus (0.1) aotus (0.4), azarai (0.2)</code></pre>
<p>This summary provides information on each cluster in the phylota object, such as median sequence length, MAD score (the mean alignment density, values closer to 1 indicate all the sequences are of a similar length), most common words in the sequence descriptions and feature names. Let’s select the second ID in this table for further investigation. We can extract its cluster and sequences records in the following way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cid &lt;-<span class="st"> </span>smmry[<span class="dv">2</span>, <span class="st">'ID'</span>]
<span class="co"># get the cluster record</span>
cluster_record &lt;-<span class="st"> </span>selected<span class="op">@</span>clstrs[[cid]]
<span class="co"># use the seq. IDs to get the sequence records</span>
seq_records &lt;-<span class="st"> </span>selected<span class="op">@</span>sqs[cluster_record<span class="op">@</span>sids]
<span class="co"># extract a single record</span>
seq_record &lt;-<span class="st"> </span>seq_records[[seq_records<span class="op">@</span>ids[[<span class="dv">1</span>]]]]
<span class="co"># get the sequence</span>
seq &lt;-<span class="st"> </span><span class="kw">rawToChar</span>(seq_record<span class="op">@</span>sq)</code></pre></div>
<p>We could extract and write out each of the sequences for a cluster in the above manner. Handily, however, <code>phylotaR</code> comes with some tools to make outputting sequences easier. First because there are multiple sequences per taxon, we need to select a single representative sequence. We can do this with the <code><a href="../reference/drop_by_rank.html">drop_by_rank()</a></code> function. With this function we choose a taxonomic rank at which we would like our sequences to be represented. The function then chooses the ‘best’ sequence representing each taxon for that rank using a range of criteria. With this new phylota object, we can then extract the scientific names and write out the sequences.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># choose best sequence per species</span>
reduced &lt;-<span class="st"> </span><span class="kw"><a href="../reference/drop_by_rank.html">drop_by_rank</a></span>(<span class="dt">phylota =</span> selected, <span class="dt">rnk =</span> <span class="st">'species'</span>, <span class="dt">n =</span> <span class="dv">1</span>)
<span class="co"># get txids at the species level for each sequence</span>
txids &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_txids.html">get_txids</a></span>(<span class="dt">phylota =</span> reduced, <span class="dt">cid =</span> cid, <span class="dt">rnk =</span> <span class="st">'species'</span>)
<span class="co"># look up name for txids</span>
scientific_names &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_tx_slot.html">get_tx_slot</a></span>(<span class="dt">phylota =</span> reduced, <span class="dt">txid =</span> txids, <span class="dt">slt_nm =</span> <span class="st">'scnm'</span>)
<span class="co"># clean the names</span>
scientific_names &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">'</span><span class="ch">\\</span><span class="st">.'</span>, <span class="st">''</span>, scientific_names)
scientific_names &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">'</span><span class="ch">\\</span><span class="st">s+'</span>, <span class="st">'_'</span>, scientific_names)
<span class="co"># look up sequence IDs for our chosen cluster</span>
sids &lt;-<span class="st"> </span>reduced<span class="op">@</span>clstrs[[cid]]<span class="op">@</span>sids
<span class="co"># write out</span>
<span class="kw"><a href="../reference/write_sqs.html">write_sqs</a></span>(<span class="dt">phylota =</span> reduced, <span class="dt">sid =</span> sids, <span class="dt">outfile =</span> <span class="st">'cytb.fasta'</span>,
          <span class="dt">sq_nm =</span> scientific_names)</code></pre></div>
</div>
<div id="testing-output" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-output" class="anchor"></a>Testing output</h2>
<p>We can sanity check our cluster sequences by running a very quick phylogenetic analysis using mafft and raxml. The below code will use the cluster to generate an alignment and a tree through R. In order for the code to run, it requires the installation of mafft and raxml and, additionally, may require tweaking to work on your system.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ape)
<span class="kw">system</span>(<span class="st">'mafft --auto cytb.fasta &gt; alignment.fasta'</span>)
<span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">'raxmlHPC -m GTRGAMMA -f a -N 10 -p 1234 -x 1234 -n aotus -s alignment.fasta'</span>))
tree &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/read.tree">read.tree</a></span>(<span class="dt">file =</span> <span class="st">'RAxML_bestTree.aotus'</span>)
<span class="kw">plot</span>(tree, <span class="dt">no.margin =</span> <span class="ot">TRUE</span>, <span class="dt">type =</span> <span class="st">'unrooted'</span>)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#installing-ncbi-blast-tools">Installing NCBI BLAST+ Tools</a></li>
      <li>
<a href="#pipeline">Pipeline</a><ul class="nav nav-pills nav-stacked">
<li><a href="#setup">Setup</a></li>
      <li><a href="#running">Running</a></li>
      <li><a href="#restarting">Restarting</a></li>
      <li><a href="#cluster-selection">Cluster selection</a></li>
      <li><a href="#testing-output">Testing output</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Hannes Hettling, Rutger Vos, Alexander Zizka, Dom Bennett, Alexandre Antonelli.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
